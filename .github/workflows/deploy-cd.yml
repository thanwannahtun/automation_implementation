name: Deployment

on:
  pull_request:
    branches: [ "main" ]



jobs:
  deploy:
    name: Deploy to Github Pages
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # Step 2: Install jq
      # jq is used to parse JSON when downloading the build artifact
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # Step 3: Set Up Flutter
      - name: Set Up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.3'
          channel: 'stable'
          cache: true

      # Step 4: Download build artifact from the latest release
      - name: Download Build Artifact from Release
        run: |
          curl -L -o android_builds.tar.gz \
          "$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest \
          | jq -r '.assets[] | select(.name == "android_builds.tar.gz").browser_download_url')"


      # Step 5: Extract the downloaded artifact
      - name: Extract Artifact
        run: |
          mkdir deploy_output
          tar -xzf android_builds.tar.gz -C deploy_output

      # Step 6: Debug artifact contents
      - name: Debug List Downloaded Artifacts
        run: |
          echo "Extracted assets:"
          ls -R deploy_output


      # Install Firebase CLI via npm globally
      - name: Install Firebase CLI
        run: |
          sudo apt-get install -y npm
          sudo npm install -g firebase-tools





      # Authenticate Firebase 
      - name: Authenticate Firebase CLI
        run: |
          echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}" > firebase_key.json
          export GOOGLE_APPLICATION_CREDENTIALS=firebase_key.json
          firebase projects:list  # This is used for debugging the CLI authentication
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}







   
#      # Step 8: Authenticate Firebase CLI using personal tokens less secure compared to Service Account Key
#      # Authenticates the CLI using a Firebase token stored as a GitHub secret
#      - name: Authenticate Firebase CLI
#        run: firebase login:ci --token ${{ secrets.FIREBASE_AUTH_TOKEN }}

      # Step 9: Upload APK to Firebase App Distribution
      # Deploys the APK to Firebase, using app ID and tester groups stored as secrets
      # https://firebase.google.com/docs/app-distribution/android/distribute-cli
      - name: Upload APK to Firebase App Distribution
        run: |
          firebase appdistribution:distribute deploy_output/app-release.apk \
          --app ${{ secrets.FIREBASE_APP_ID }} \
          --groups ${{ secrets.FIREBASE_TESTER_GROUPS }}

      # Optional: Debug Firebase CLI output
      - name: Debug Firebase Output
        run: echo "Firebase Distribution Completed!"